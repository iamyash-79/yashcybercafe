<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Account Settings - Yash Cyber Cafe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs" defer></script>
</head>
<body class="min-h-screen bg-[#0f172a] text-cyan-100">

<main class="max-w-4xl mx-auto px-4 sm:px-6 py-8">
  <div class="flex items-center justify-between mb-6">
  <a href="/home" class="flex items-center text-cyan-300 hover:text-cyan-100 transition mb-4">
    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
    </svg>
    <span class="font-semibold">Back</span>
  </a>
  <h1 class="text-2xl sm:text-3xl font-bold text-cyan-300 text-center flex-1">👤 Account Settings</h1>
</div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="my-4">
        {% for category, message in messages %}
          <div class="px-4 py-2 rounded mb-2 text-sm
            {% if category == 'success' %} bg-green-900 text-green-200
            {% elif category == 'error' %} bg-red-900 text-red-200
            {% else %} bg-gray-900 text-white {% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Profile Form -->
  <form method="POST" enctype="multipart/form-data" class="bg-white/5 backdrop-blur-md p-6 rounded-xl border border-white/10 shadow-lg shadow-cyan-500/10">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="space-y-4">
        <div>
          <label class="text-sm font-bold text-cyan-300">Full Name</label>
          <input type="text" name="full_name" value="{{ user.full_name }}" required
                 class="w-full px-3 py-2 rounded-md bg-transparent border border-cyan-500/30 text-white placeholder-cyan-200" />
        </div>
        <div>
          <label class="text-sm font-bold text-cyan-300">Gender</label>
          <select name="gender_id" required
                  class="w-full px-3 py-2 rounded-md bg-[#1e293b] border border-cyan-500/30 text-white">
            <option value="1" {% if user.gender_id|int == 1 or not user.gender_id %}selected{% endif %}>Male</option>
            <option value="2" {% if user.gender_id|int == 2 %}selected{% endif %}>Female</option>
            <option value="3" {% if user.gender_id|int == 3 %}selected{% endif %}>Other</option>
          </select>
        </div>
        <button type="submit" class="px-4 py-2 rounded-md bg-cyan-400 text-black hover:bg-cyan-300 shadow-md shadow-cyan-500 w-full lg:w-auto">💾 Save Changes</button>
      </div>

      <div class="flex flex-col items-center justify-center space-y-2">
        <label for="image-upload" class="cursor-pointer relative group">
          {% if user.profile_image %}
            <img src="{{ user.profile_image }}" class="w-32 h-32 rounded-full border-2 border-cyan-300 object-cover" />
          {% else %}
            {% if user.gender_id|int == 2 %}
              <img src="{{ url_for('static', filename='images/default_female.png') }}" class="w-32 h-32 rounded-full border-2 border-cyan-300" />
            {% else %}
              <img src="{{ url_for('static', filename='images/default_male.png') }}" class="w-32 h-32 rounded-full border-2 border-cyan-300" />
            {% endif %}
          {% endif %}
          <div class="absolute bottom-1 right-1 bg-black/60 rounded-full p-1 shadow">
            <svg class="w-5 h-5 text-cyan-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536M9 11l6-6 3 3-6 6H9v-3z"/>
            </svg>
          </div>
        </label>
        <input type="file" name="image" id="image-upload" class="hidden" />
        {% if user.profile_image %}
          <button name="remove_image" value="1" class="text-red-400 text-sm hover:underline mt-2">Remove Photo</button>
        {% endif %}
      </div>
    </div>
  </form>

    <!-- Login Info Card -->
    <div class="mt-10 bg-white/5 backdrop-blur-md p-6 rounded-xl border border-white/10 shadow shadow-cyan-500/10">
      <h2 class="text-xl font-bold text-cyan-300 mb-4">🔐 Login Info</h2>
      <div class="space-y-6">
        <div class="relative">
          <label class="text-cyan-400 block">Email</label>
          <p class="text-cyan-100 mt-1 break-all">{{ user.email }}</p>
          <button onclick="document.getElementById('infoModal').classList.remove('hidden')"
            class="absolute top-0 right-0 text-xs px-2 py-1 bg-blue-500 text-white rounded shadow hover:bg-blue-400">✉️ Change</button>
        </div>

        <div class="relative">
          <label class="text-cyan-400 block">Mobile</label>
          <p class="text-cyan-100 mt-1 break-words">{{ user.contact }}</p>
        </div>

        <div class="relative">
          <label class="text-cyan-400 block">Password</label>
          <p class="text-cyan-100 mt-1">••••••••</p>
          <button onclick="document.getElementById('passwordModal').classList.remove('hidden')"
            class="absolute top-0 right-0 text-xs px-2 py-1 bg-yellow-500 text-black rounded shadow hover:bg-yellow-400">🔒 Change</button>
        </div>

        <div class="relative">
          <label class="text-cyan-400 block">Security Question</label>
          <p class="text-cyan-100 mt-1">{{ user.security_question or "Not Set" }}</p>
          {% if user.security_question %}
            <label class="text-cyan-400 block mt-2">Your Answer</label>
            <p class="text-cyan-100 mt-1">{{ user.security_answer }}</p>
          {% endif %}
          <button onclick="document.getElementById('securityModal').classList.remove('hidden')"
            class="absolute top-0 right-0 text-xs px-2 py-1 bg-purple-500 text-white rounded shadow hover:bg-purple-400">
            {% if user.security_question %}🔁 Change{% else %}🛡️ Set{% endif %}
          </button>
        </div>
      </div>
    </div>
</div>

<!-- Security Modal -->
<div id="securityModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
  <div class="bg-white/5 p-6 rounded-xl border border-white/10 text-white w-full max-w-md relative">
    <button onclick="document.getElementById('securityModal').classList.add('hidden')" class="absolute top-2 right-2 text-white hover:text-red-400 text-xl">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-cyan-300">Set Security Question</h2>
    <form method="POST" action="/set-security" class="space-y-4">
      <div>
        <label class="text-sm text-cyan-400 block mb-1">Select Question</label>
        <select name="question" required class="w-full px-3 py-2 rounded-md bg-[#1e293b] border border-cyan-500/30 text-white">
          {% for q in questions %}
            <option value="{{ q[1] }}" {% if user.security_question == q[1] %}selected{% endif %}>{{ q[1] }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="text-sm text-cyan-400 block mb-1">Your Answer</label>
        <input type="text" name="answer" required value="{{ user.security_answer or '' }}"
               class="w-full px-3 py-2 rounded-md bg-[#1e293b] border border-cyan-500/30 text-white" />
      </div>
      <button type="submit" class="bg-cyan-400 text-black px-4 py-2 rounded-md hover:bg-cyan-300 shadow shadow-cyan-600">💾 Save</button>
    </form>
  </div>
</div>

<!-- Info Modal (EMAIL + OTP, CONTACT NO WITHOUT OTP) -->
<div id="infoModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
  <div class="bg-white/5 p-6 rounded-xl border border-white/10 text-white w-full max-w-md relative">
    <button onclick="document.getElementById('infoModal').classList.add('hidden')" class="absolute top-2 right-2 text-white hover:text-red-400 text-xl">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-cyan-300">Change Email or Mobile</h2>

    <form method="POST" action="/change-info" class="space-y-4" id="change-info-form">
      <label class="text-sm text-cyan-400 block">New Email</label>
      <div class="flex gap-2">
        <input type="email" name="email" id="change-email" placeholder="you@example.com"
               class="flex-1 px-3 py-2 rounded-md bg-[#1e293b] border border-cyan-500/30 text-white" />
        <button type="button" onclick="sendChangeOTP()"
                class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-400">Send OTP</button>
      </div>

      <div id="change-otp-section" style="display: none;">
        <label class="text-sm text-cyan-400 block mt-2">Enter OTP</label>
        <div class="flex gap-2">
          <input type="text" id="change-otp" name="otp"
                 class="flex-1 px-3 py-2 rounded-md bg-[#1e293b] border border-cyan-500/30 text-white" />
          <button type="button" onclick="verifyChangeOTP()"
                  class="px-3 py-2 bg-green-500 text-black rounded hover:bg-green-400">Verify</button>
        </div>
      </div>
<div style="text-align: center; margin: 0.5rem 0; font-weight: bold; color: #ccc;">OR</div>
      <label class="text-sm text-cyan-400 block mt-4">New Mobile</label>
      <input type="text" name="contact" placeholder="New Mobile Number"
             class="w-full px-3 py-2 rounded-md bg-[#1e293b] border border-cyan-500/30 text-white" />

      <button type="submit"
              class="bg-cyan-400 text-black px-4 py-2 rounded-md hover:bg-cyan-300 shadow mt-2">
        Submit
      </button>
    </form>
  </div>
</div>

<!-- ✅ Password Modal (outside infoModal) -->
<div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
  <div class="bg-white/5 p-6 rounded-xl border border-white/10 text-white w-full max-w-md relative">
    <button onclick="document.getElementById('passwordModal').classList.add('hidden')" class="absolute top-2 right-2 text-white hover:text-red-400 text-xl">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-cyan-300">Change Password</h2>
    <form method="POST" action="/change-password" class="space-y-4">
      <input type="password" name="old_password" placeholder="Current Password" required
             class="w-full px-3 py-2 rounded-md bg-[#1e293b] border border-cyan-500/30 text-white" />
      <input type="password" name="new_password" placeholder="New Password" required
             class="w-full px-3 py-2 rounded-md bg-[#1e293b] border border-cyan-500/30 text-white" />
      <input type="password" name="confirm_password" placeholder="Confirm Password" required
             class="w-full px-3 py-2 rounded-md bg-[#1e293b] border border-cyan-500/30 text-white" />
      <button type="submit" class="bg-cyan-400 text-black px-4 py-2 rounded-md hover:bg-cyan-300 shadow">Submit</button>
    </form>
  </div>
</div>

<script>
  function sendChangeOTP() {
    const email = document.getElementById("change-email").value.trim();
    if (!email) {
      alert("⚠️ Enter your email to send OTP.");
      return;
    }

    fetch("/send-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("✅ OTP sent to your new email.");
        const otpSection = document.getElementById("change-otp-section");
        if (otpSection) otpSection.style.display = "block";
      } else {
        alert("❌ " + (data.message || "Failed to send OTP."));
      }
    })
    .catch(err => {
      console.error("OTP Send Error:", err);
      alert("❌ Something went wrong while sending OTP.");
    });
  }

  function verifyChangeOTP() {
    const otpInput = document.getElementById("change-otp");
    const otp = otpInput?.value.trim();
    if (!otp) {
      alert("⚠️ Enter the OTP.");
      return;
    }

    fetch("/verify-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ otp })
    })
    .then(res => res.json())
    .then(data => {
      if (data.verified) {
        alert("✅ OTP Verified!");
        if (otpInput) otpInput.style.backgroundColor = "#d1fae5";
        // Optionally mark the email as verified (e.g. set hidden input or flag)
      } else {
        alert("❌ " + (data.message || "Incorrect OTP."));
      }
    })
    .catch(err => {
      console.error("OTP Verify Error:", err);
      alert("❌ Could not verify OTP.");
    });
  }
</script>

<!-- Open password modal if requested -->
{% if request.args.get('show_change_password') == 'true' %}
  <script>
    window.addEventListener("DOMContentLoaded", function () {
      const modal = document.getElementById("passwordModal");
      if (modal) {
        modal.classList.remove("hidden");
      }
    });
  </script>
{% endif %}

  </main>
</div>
</body>
</html>
