<!DOCTYPE html>
<html lang="en" x-data="billApp()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sales - {{ full_name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="//unpkg.com/alpinejs" defer></script>
  <style>
    body {
      background: linear-gradient(135deg, #000428, #004e92);
      color: #e0f7fa;
    }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 20px rgba(0, 230, 255, 0.2);
    }

    th {
      background: rgba(0, 255, 255, 0.1);
      color: #00e6ff;
      font-weight: 600;
    }

    td {
      color: #e0f7fa;
      border-color: #1f2937;
    }

    .status-badge {
      border-radius: 9999px;
      padding: 0.25rem 0.75rem;
      font-weight: 600;
      font-size: 0.75rem;
    }

    .status-pending { background-color: #ffb300; color: black; }
    .status-accepted { background-color: #4caf50; color: white; }
    .status-cancelled { background-color: #f44336; color: white; }
    .status-delivered { background-color: #2196f3; color: white; }
  </style>
</head>
<body class="font-sans">

<div class="flex flex-col md:flex-row min-h-screen">

  <!-- Sidebar -->
  <div class="w-full md:w-64 md:h-full md:fixed z-50">
    {% include 'sidebar.html' %}
  </div>

  <!-- Main Content -->
  <main class="flex-1 px-4 sm:px-6 py-4 pt-20 md:ml-64">

    <!-- Page Header -->
    <header class="flex justify-between items-center mb-6 text-cyan-300">
      <h1 class="text-3xl font-semibold">Sales Overview</h1>
    </header>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-4 space-y-2">
          {% for category, message in messages %}
            <div class="p-3 rounded glass text-sm border 
                        {% if category == 'success' %} border-green-400 text-green-300 
                        {% elif category == 'error' %} border-red-400 text-red-300 
                        {% else %} border-cyan-400 text-cyan-300 {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Analytics Summary -->
    <div class="glass p-6 rounded-xl mb-8">
      <h2 class="text-xl font-bold text-cyan-400 mb-4">Sales Analytics</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center text-white">
        <a href="{{ url_for('orders') }}" class="glass p-4 rounded hover:scale-105 transition transform">
          <div class="text-sm text-cyan-300">Total Orders</div>
          <div class="text-xl font-bold">{{ total_orders }}</div>
        </a>
        <a href="{{ url_for('orders', status='delivered') }}" class="glass p-4 rounded hover:scale-105 transition transform">
          <div class="text-sm text-green-300">Delivered Orders</div>
          <div class="text-xl font-bold">{{ delivered_orders }}</div>
        </a>
        <a href="{{ url_for('orders', status='pending') }}" class="glass p-4 rounded hover:scale-105 transition transform">
          <div class="text-sm text-yellow-300">Pending Orders</div>
          <div class="text-xl font-bold">{{ pending_orders }}</div>
        </a>
        <div class="glass p-4 rounded">
          <div class="text-sm text-purple-300">Online Revenue</div>
          <div class="text-xl font-bold text-purple-100">‚Çπ{{ total_revenue }}</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 text-center">
        <div class="glass p-4 rounded">
          <div class="text-sm text-indigo-300">Offline Revenue</div>
          <div class="text-xl font-bold text-indigo-100">‚Çπ{{ offline_revenue }}</div>
        </div>
        <div class="glass p-4 rounded border border-green-300">
          <div class="text-sm text-green-400 font-medium">Grand Revenue</div>
          <div class="text-2xl font-bold text-green-100">‚Çπ{{ grand_revenue }}</div>
        </div>
      </div>
    </div>

    <!-- Online Orders Table -->
    <div class="glass p-6 rounded-xl mb-10">
      <h2 class="text-lg font-bold text-cyan-300 mb-4">All Orders (Online)</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto text-sm border border-cyan-400 rounded-xl overflow-hidden">
          <thead>
            <tr>
              <th class="px-4 py-2">Item</th>
              <th class="px-4 py-2">Qty</th>
              <th class="px-4 py-2">Amount</th>
              <th class="px-4 py-2">Status</th>
              <th class="px-4 py-2">User</th>
              <th class="px-4 py-2">Date</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
            <tr class="border-b border-cyan-800 hover:bg-cyan-900/30">
              <td class="px-4 py-2">{{ order.item_name }}</td>
              <td class="px-4 py-2">{{ order.quantity }}</td>
              <td class="px-4 py-2">‚Çπ{{ order.amount }}</td>
              <td class="px-4 py-2">
                <span class="status-badge
                  {% if order.status == 'delivered' %}status-delivered
                  {% elif order.status == 'pending' %}status-pending
                  {% elif order.status == 'cancelled' %}status-cancelled
                  {% else %}status-accepted{% endif %}">
                  {{ order.status }}
                </span>
              </td>
              <td class="px-4 py-2">{{ order.user_name }}</td>
              <td class="px-4 py-2">{{ order.order_date }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if orders|length == 0 %}
          <p class="text-center text-cyan-200 mt-4">No online orders available.</p>
        {% endif %}
      </div>
    </div>

    <!-- Offline Bills Table -->
<div class="glass p-6 rounded-xl mb-10">
  <h2 class="text-lg font-bold text-cyan-300 mb-4">Offline Bills</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full table-auto text-sm border border-cyan-400 rounded-xl overflow-hidden">
      <thead>
        <tr class="text-cyan-300 text-xs uppercase border-b border-cyan-500 bg-[#0f172a] sticky top-0 z-10">
          <th class="px-4 py-2">S.No.</th>
          <th class="px-4 py-2">Name</th>
          <th class="px-4 py-2">Contact</th>
          <th class="px-4 py-2">Amount</th>
          <th class="px-4 py-2">Address</th>
          <th class="px-4 py-2">Date & Time</th>
          <th class="px-4 py-2">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for bill in bills %}
        <tr class="border-b border-cyan-800 hover:bg-cyan-900/30 transition">
          <td class="px-4 py-2">{{ loop.index }}</td>
          <td class="px-4 py-2">{{ bill.name }}</td>
          <td class="px-4 py-2">{{ bill.contact }}</td>
          <td class="px-4 py-2 text-green-400 font-semibold">‚Çπ{{ bill.total }}</td>
          <td class="px-4 py-2">{{ bill.address }}</td>
          <td class="px-4 py-2">{{ bill.date }}</td>
          <td class="px-4 py-2 flex gap-2">
            <a href="/bill/print/{{ bill.id }}" target="_blank" class="text-cyan-300 neon-hover text-sm">üñ®Ô∏è</a>
            <form method="POST" action="/bill/delete/{{ bill.id }}" onsubmit="return confirm('Delete this bill?')">
              <button class="text-red-400 hover:underline text-sm">üóëÔ∏è</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="text-center py-4 text-cyan-100/50">No offline bills available.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

    <!-- Floating Add Button -->
    <button @click="showForm = true"
      class="fixed bottom-14 right-4 bg-cyan-600 hover:bg-cyan-400 text-white text-lg px-5 py-3 rounded-full shadow-lg transition duration-300 z-50">
      ‚ûï Add Bill
    </button>

    <!-- Add Bill Modal -->
    <div x-show="showForm" x-cloak class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-3">
      <form method="POST" @submit="calculateTotal"
            class="glass text-white p-5 rounded-xl w-full max-w-3xl shadow-xl space-y-4 max-h-[95vh] overflow-y-auto">
        <h2 class="text-2xl font-bold text-cyan-300">Add New Bill</h2>

        <!-- Customer Info -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <input name="name" type="text" placeholder="Name *" required class="bg-transparent border border-cyan-400 rounded p-2 w-full" />
          <input name="contact" type="text" placeholder="Contact No. *" required class="bg-transparent border border-cyan-400 rounded p-2 w-full" />
          <input name="address1" type="text" placeholder="Address Line 1" class="bg-transparent border border-cyan-400 rounded p-2 w-full" />
          <input name="address2" type="text" placeholder="Address Line 2" class="bg-transparent border border-cyan-400 rounded p-2 w-full" />
          <input name="city" type="text" placeholder="City" class="bg-transparent border border-cyan-400 rounded p-2 w-full" />
          <input name="pincode" type="text" placeholder="Pincode" class="bg-transparent border border-cyan-400 rounded p-2 w-full" />
        </div>

        <!-- Products -->
        <div class="space-y-2">
          <label class="block text-lg font-bold text-cyan-300">üõí Products</label>
          <template x-for="(products, i) in products" :key="i">
            <div class="flex items-center gap-2">
              <select :name="`products_name_${i}`" class="w-full bg-gray-800 border border-cyan-400 rounded p-2 text-white" @change="updateTotal">
                <option value="">-- Select products --</option>
                {% for p in products %}
                <option value="{{ p.name }}" :data-price="{{ p.discount_price or p.price }}">{{ p.name }}</option>
                {% endfor %}
              </select>
              <input :name="`products_qty_${i}`" type="number" min="1" value="1"
                     class="w-20 bg-gray-800 text-white border border-cyan-400 rounded p-1" @input="updateTotal" />
              <button type="button" @click="products.splice(i, 1)" class="text-red-400 text-sm">‚úñ</button>
            </div>
          </template>
          <button type="button" @click="products.push({})" class="text-cyan-400 text-sm mt-1 neon-hover">+ Add products</button>
        </div>

        <!-- Services -->
        <div class="space-y-2">
          <label class="block text-lg font-bold text-cyan-300">üõ†Ô∏è Services</label>
          <template x-for="(service, i) in selectedServices" :key="i">
            <div class="flex items-center gap-2">
              <select :name="`service_name_${i}`" class="w-full bg-gray-800 border border-cyan-400 rounded p-2 text-white" @change="updateTotal">
                <option value="">-- Select Service --</option>
                {% for s in services %}
                <option value="{{ s.name }}" :data-price="{{ s.discount_price or s.price }}">{{ s.name }}</option>
                {% endfor %}
              </select>
              <input :name="`service_qty_${i}`" type="number" min="1" value="1"
                     class="w-20 bg-gray-800 text-white border border-cyan-400 rounded p-1" @input="updateTotal" />
              <button type="button" @click="selectedServices.splice(i, 1)" class="text-red-400 text-sm">‚úñ</button>
            </div>
          </template>
          <button type="button" @click="selectedServices.push({})" class="text-cyan-400 text-sm mt-1 neon-hover">+ Add Service</button>
        </div>

        <!-- Total -->
        <input name="total" x-model="total" type="number" step="0.01" readonly
               class="w-full border border-cyan-500 bg-cyan-900/40 rounded p-2 text-xl font-bold text-cyan-100" placeholder="Total ‚Çπ" />

        <!-- Submit Buttons -->
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" @click="showForm = false" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-white">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded text-white font-bold">üíæ Save Bill</button>
        </div>
      </form>
    </div>

  </main>
</div>

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('billApp', () => ({
      showForm: false,
      products: [{}],
      selectedServices: [{}],
      total: 0,
      updateTotal() {
        let total = 0;

        document.querySelectorAll("select[name^='products_name_']").forEach((sel, i) => {
          const qty = parseInt(document.querySelector(`input[name='products_qty_${i}']`)?.value || 1);
          const price = parseFloat(sel.selectedOptions[0]?.getAttribute("data-price") || 0);
          total += qty * price;
        });

        document.querySelectorAll("select[name^='service_name_']").forEach((sel, i) => {
          const qty = parseInt(document.querySelector(`input[name='service_qty_${i}']`)?.value || 1);
          const price = parseFloat(sel.selectedOptions[0]?.getAttribute("data-price") || 0);
          total += qty * price;
        });

        this.total = total.toFixed(2);
      }
    }))
  })
</script>

</body>
</html>
